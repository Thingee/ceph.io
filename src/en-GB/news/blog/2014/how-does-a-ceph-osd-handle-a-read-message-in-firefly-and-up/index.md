---
title: "How does a Ceph OSD handle a read message ? (in Firefly and up)"
date: "2014-02-24"
author: "loic"
tags: 
  - "ceph"
  - "planet"
---

When an [OSD handles an operation](https://github.com/ceph/ceph/blob/27968a74d29998703207705194ec4e0c93a6b42d/src/osd/OSD.cc#L4796) it is [queued to a PG](https://github.com/ceph/ceph/blob/27968a74d29998703207705194ec4e0c93a6b42d/src/osd/OSD.cc#L7334), it is [added to the op\_wq work queue](https://github.com/ceph/ceph/blob/27968a74d29998703207705194ec4e0c93a6b42d/src/osd/OSD.cc#L7392) ( or to the _waiting\_for\_map_ list if the [queue\_op method of PG](https://github.com/ceph/ceph/blob/27968a74d29998703207705194ec4e0c93a6b42d/src/osd/PG.cc#L1732) finds that it must wait for an OSDMap ) and will be [dequeued](https://github.com/ceph/ceph/blob/27968a74d29998703207705194ec4e0c93a6b42d/src/osd/OSD.cc#L7498) asynchronously. The dequeued operation is processed by the [ReplicatedPG::do\_request method](https://github.com/ceph/ceph/blob/27968a74d29998703207705194ec4e0c93a6b42d/src/osd/ReplicatedPG.cc#L1049) which [calls](https://github.com/ceph/ceph/blob/27968a74d29998703207705194ec4e0c93a6b42d/src/osd/ReplicatedPG.cc#L1092) the the [do\_op method](https://github.com/ceph/ceph/blob/27968a74d29998703207705194ec4e0c93a6b42d/src/osd/ReplicatedPG.cc#L1160) because it is [a CEPH\_MSG\_OSD\_OP](https://github.com/ceph/ceph/blob/27968a74d29998703207705194ec4e0c93a6b42d/src/messages/MOSDOp.h#L94). An OpContext [is allocated](https://github.com/ceph/ceph/blob/27968a74d29998703207705194ec4e0c93a6b42d/src/osd/ReplicatedPG.cc#L1409) and is [executed](https://github.com/ceph/ceph/blob/27968a74d29998703207705194ec4e0c93a6b42d/src/osd/ReplicatedPG.cc#L1450).

> 2014-02-24 09:28:34.571489 7fc18006f700 10 osd.4 pg\_epoch: 26 pg\[3.7s0( v 26'1 (0'0,26'1\] local-les=26 n=1 ec=25 les/c 26/26 25/25/25) \[4,6,9\] r=0 lpr=25 crt=0’0 lcod 0’0 mlcod 0’0 active+clean\] **execute\_ctx** 0x7fc16c08a3b0

A [transaction](https://github.com/ceph/ceph/blob/27968a74d29998703207705194ec4e0c93a6b42d/src/osd/ReplicatedPG.cc#L1619) (which is either a [RPGTransaction](https://github.com/ceph/ceph/blob/27968a74d29998703207705194ec4e0c93a6b42d/src/osd/PGBackend.h#L270) for a [replicated backend](https://github.com/ceph/ceph/blob/27968a74d29998703207705194ec4e0c93a6b42d/src/osd/ReplicatedBackend.cc#L456) or an [ECTransaction](https://github.com/ceph/ceph/blob/27968a74d29998703207705194ec4e0c93a6b42d/src/osd/ECTransaction.h#L27) for an [erasure coded backend](https://github.com/ceph/ceph/blob/27968a74d29998703207705194ec4e0c93a6b42d/src/osd/ECBackend.cc#L1151)) is obtained from the [PGBackend](https://github.com/ceph/ceph/blob/27968a74d29998703207705194ec4e0c93a6b42d/src/osd/PGBackend.h#L477). The transaction is attached to a OpContext (which was [allocated by do\_op](https://github.com/ceph/ceph/blob/27968a74d29998703207705194ec4e0c93a6b42d/src/osd/ReplicatedPG.cc#L1409)). Note that in the following log line although **do\_op** shows, it [comes from the execute\_ctx method](https://github.com/ceph/ceph/blob/27968a74d29998703207705194ec4e0c93a6b42d/src/osd/ReplicatedPG.cc#L1680).

> 2014-02-24 09:28:34.571563 7fc18006f700 10 osd.4 pg\_epoch: 26 pg\[3.7s0( v 26'1 (0'0,26'1\] local-les=26 n=1 ec=25 les/c 26/26 25/25/25) \[4,6,9\] r=0 lpr=25 crt=0’0 lcod 0’0 mlcod 0’0 active+clean\] **do\_op** 847441d7/SOMETHING/head//3 \[read 0~4194304\] ov 26’1

The **execute\_ctx** method [calls prepare\_transaction](https://github.com/ceph/ceph/blob/27968a74d29998703207705194ec4e0c93a6b42d/src/osd/ReplicatedPG.cc#L1701) which [calls do\_osd\_ops](https://github.com/ceph/ceph/blob/27968a74d29998703207705194ec4e0c93a6b42d/src/osd/ReplicatedPG.cc#L4900) which [prepares the CEPH\_OSD\_OP\_READ](https://github.com/ceph/ceph/blob/27968a74d29998703207705194ec4e0c93a6b42d/src/osd/ReplicatedPG.cc#L2941).

> 2014-02-24 09:28:34.571663 7fc18006f700 10 osd.4 pg\_epoch: 26 pg\[3.7s0( v 26'1 (0'0,26'1\] local-les=26 n=1 ec=25 les/c 26/26 25/25/25) \[4,6,9\] r=0 lpr=25 crt=0’0 lcod 0’0 mlcod 0’0 active+clean\] **async\_read noted for** 847441d7/SOMETHING/head//3

The **execute\_ctx** method continues when **prepare\_transaction** returns and [creates the MOSDOpReply](https://github.com/ceph/ceph/blob/27968a74d29998703207705194ec4e0c93a6b42d/src/osd/ReplicatedPG.cc#L1732) object. Then it [calls start\_async\_reads](https://github.com/ceph/ceph/blob/27968a74d29998703207705194ec4e0c93a6b42d/src/osd/ReplicatedPG.cc#L1755) which [calls objects\_read\_async on the backend](https://github.com/ceph/ceph/blob/27968a74d29998703207705194ec4e0c93a6b42d/src/osd/ReplicatedPG.cc#L122) (which is either [ReplicatedBackend::objects\_read\_async](https://github.com/ceph/ceph/blob/27968a74d29998703207705194ec4e0c93a6b42d/src/osd/ReplicatedBackend.cc#L242) or [ECBackend::objects\_read\_async](https://github.com/ceph/ceph/blob/27968a74d29998703207705194ec4e0c93a6b42d/src/osd/ECBackend.cc#L1602)). When the read completes (this code path is not explored here), it calls [the OnReadComplete::finish](https://github.com/ceph/ceph/blob/27968a74d29998703207705194ec4e0c93a6b42d/src/osd/ReplicatedPG.cc#L107) method (because the OnReadComplete object was given as an argument to **objects\_read\_async**) which calls [ReplicatedPG::OpContext::finish\_read](https://github.com/ceph/ceph/blob/27968a74d29998703207705194ec4e0c93a6b42d/src/osd/ReplicatedPG.cc#L128) each time a ready completes (i.e. if reading from an erasure coded pool, on each chunk) which calls [ReplicatedPG::complete\_read\_ctx](https://github.com/ceph/ceph/blob/27968a74d29998703207705194ec4e0c93a6b42d/src/osd/ReplicatedPG.cc#L5120) (if there are no pending reads) which [sends the reply to the client](https://github.com/ceph/ceph/blob/27968a74d29998703207705194ec4e0c93a6b42d/src/osd/ReplicatedPG.cc#L5142) .
