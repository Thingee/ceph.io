---
title: "Ansible module to manage CephX Keys"
date: "2018-04-01"
author: "admin"
tags: 
  - "planet"
---

![Title](images/ceph-ansible-cephx-module.jpg)

Following our recent initiative on writing more Ceph modules for Ceph Ansible, Iâ€™d like to introduce one that I recently wrote: **ceph\_key**.

The module is pretty straightforward to use and will ease your day two operations for managing CephX keys. It has several capabilities such as:

- create: will create the key on the filesystem with the right permissions (support `mode`/`owner`) and will import in the Ceph (can be enabled/disabled) with the given capabilities
- update: will update the capabilities of a particular key
- delete: will delete the key from Ceph
- info: will get every information about a particular key
- list: will list all the available keys

The module also works on containerized Ceph clusters.

See the following examples:

<table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># This playbook is used to manage CephX Keys</span></span><br><span class="line"><span class="comment"># You will find examples below on how the module can be used on daily operations</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># It currently runs on localhost</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- hosts:</span> localhost</span><br><span class="line"><span class="attr">  gather_facts:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">    cluster:</span> ceph</span><br><span class="line"><span class="attr">    keys_to_info:</span></span><br><span class="line"><span class="bullet">      -</span> client.admin</span><br><span class="line"><span class="bullet">      -</span> mds<span class="number">.0</span></span><br><span class="line"><span class="attr">    keys_to_delete:</span></span><br><span class="line"><span class="bullet">      -</span> client.leseb</span><br><span class="line"><span class="bullet">      -</span> client.leseb1</span><br><span class="line"><span class="bullet">      -</span> client.pythonnnn</span><br><span class="line"><span class="attr">    keys_to_create:</span></span><br><span class="line"><span class="bullet">      -</span> { name: client.pythonnnn, caps: { mon: <span class="string">"allow rwx"</span>, mds: <span class="string">"allow *"</span> } , mode: <span class="string">"0600"</span> }</span><br><span class="line"><span class="bullet">      -</span> { name: client.existpassss, caps: { mon: <span class="string">"allow r"</span>, osd: <span class="string">"allow *"</span> } , mode: <span class="string">"0600"</span> }</span><br><span class="line"><span class="bullet">      -</span> { name: client.path, caps: { mon: <span class="string">"allow r"</span>, osd: <span class="string">"allow *"</span> } , mode: <span class="string">"0600"</span> }</span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> create ceph key(s) module</span><br><span class="line"><span class="attr">      ceph_key:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">"<span class="template-variable">\{\{ item.name \}\}</span>"</span></span><br><span class="line"><span class="attr">        state:</span> present</span><br><span class="line"><span class="attr">        caps:</span> <span class="string">"<span class="template-variable">\{\{ item.caps \}\}</span>"</span></span><br><span class="line"><span class="attr">        cluster:</span> <span class="string">"<span class="template-variable">\{\{ cluster \}\}</span>"</span></span><br><span class="line"><span class="attr">        secret:</span> <span class="string">"<span class="template-variable">\{\{ item.key | default('') \}\}</span>"</span></span><br><span class="line"><span class="attr">      with_items:</span> <span class="string">"<span class="template-variable">\{\{ keys_to_create \}\}</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    - name:</span> update ceph key(s)</span><br><span class="line"><span class="attr">      ceph_key:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">"<span class="template-variable">\{\{ item.name \}\}</span>"</span></span><br><span class="line"><span class="attr">        state:</span> update</span><br><span class="line"><span class="attr">        caps:</span> <span class="string">"<span class="template-variable">\{\{ item.caps \}\}</span>"</span></span><br><span class="line"><span class="attr">        cluster:</span> <span class="string">"<span class="template-variable">\{\{ cluster \}\}</span>"</span></span><br><span class="line"><span class="attr">      with_items:</span> <span class="string">"<span class="template-variable">\{\{ keys_to_create \}\}</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    - name:</span> delete ceph key(s)</span><br><span class="line"><span class="attr">      ceph_key:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">"<span class="template-variable">\{\{ item \}\}</span>"</span></span><br><span class="line"><span class="attr">        state:</span> absent</span><br><span class="line"><span class="attr">        cluster:</span> <span class="string">"<span class="template-variable">\{\{ cluster \}\}</span>"</span></span><br><span class="line"><span class="attr">      with_items:</span> <span class="string">"<span class="template-variable">\{\{ keys_to_delete \}\}</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    - name:</span> info ceph key(s)</span><br><span class="line"><span class="attr">      ceph_key:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">"<span class="template-variable">\{\{ item \}\}</span>"</span></span><br><span class="line"><span class="attr">        state:</span> info</span><br><span class="line"><span class="attr">        cluster:</span> <span class="string">"<span class="template-variable">\{\{ cluster \}\}</span>"</span></span><br><span class="line"><span class="attr">      register:</span> key_info</span><br><span class="line"><span class="attr">      ignore_errors:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      with_items:</span> <span class="string">"<span class="template-variable">\{\{ keys_to_info \}\}</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    - name:</span> list ceph key(s)</span><br><span class="line"><span class="attr">      ceph_key:</span></span><br><span class="line"><span class="attr">        state:</span> list</span><br><span class="line"><span class="attr">        cluster:</span> <span class="string">"<span class="template-variable">\{\{ cluster \}\}</span>"</span></span><br><span class="line"><span class="attr">      register:</span> list_keys</span><br><span class="line"><span class="attr">      ignore_errors:</span> <span class="literal">true</span></span><br></pre></td></tr></tbody></table>

  

> The goal is to have all of our Ceph modules included by default in Ansible. Stay tuned, more modules to come!

Source: Sebastian Han ([Ansible module to manage CephX Keys](https://sebastien-han.fr/blog/2018/04/02/Ansible-module-to-manage-CephX-Keys/))
